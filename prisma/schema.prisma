datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/* ---------- ENUMS ---------- */

enum KnowledgeDocumentType {
  FAQ
  DOCUMENTO
  CONTRATO
  PLAN
  TICKET
  COBRO
  OTRO
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

enum ChatChannel {
  WHATSAPP
  WEB
  TELEGRAM
  SMS
  OTHER
}

enum ChatSessionStatus {
  OPEN
  CLOSED
  ARCHIVED
}

/* ---------- EMPRESA / CLIENTE ---------- */

model Empresa {
  id            Int              @id @default(autoincrement())
  nombre        String
  slug          String           @unique   // "nova-sistemas", etc.
  activo        Boolean          @default(true)

  creadoEn      DateTime         @default(now())
  actualizadoEn DateTime         @updatedAt

  clientes      Cliente[]
  documentos    KnowledgeDocument[]
  sesiones      ChatSession[]
  bots          Bot[]           
}

enum BotStatus {
  ACTIVE
  DISABLED
}

model Bot {
  id           Int       @id @default(autoincrement())

  empresa      Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  empresaId    Int

  nombre       String
  slug         String    @unique
  descripcion  String?

  // LLM / proveedor
  provider     String    @default("fireworks")
  model        String    @default("accounts/fireworks/models/gpt-oss-120b")

  //  Comportamiento principal (persona)
  // Puedes tratarlo como template: "Eres el asistente de {{empresaNombre}} ..."
  systemPrompt   String   @db.Text

  //  C贸mo integrar contexto de RAG e historial
  contextPrompt  String?  @db.Text // "Te dar茅 contexto de base de conocimiento: {{context}} ..."
  historyPrompt  String?  @db.Text // "A continuaci贸n tienes el historial reciente: {{history}} ..."

  //  Estilo de salida (WhatsApp / web / etc.)
  outputStyle    String?  @db.Text
  // Ej: "Responde como mensaje de WhatsApp: sin tablas, solo texto plano, negritas con *...* y emojis."

  //  Par谩metros del modelo (performance en el sentido de generaci贸n)
  maxCompletionTokens Int?    @default(500)
  temperature         Float   @default(0.7)
  topP                Float?  @default(0.9)
  frequencyPenalty    Float?  @default(0.2)
  presencePenalty     Float?  @default(0.0)

  maxHistoryMessages  Int?    @default(15)
  status        BotStatus @default(ACTIVE)

  creadoEn      DateTime  @default(now())
  actualizadoEn DateTime  @updatedAt

  sesiones       ChatSession[]
  // knowledgeLinks BotKnowledge[]
  // channelConfigs BotChannelConfig[]
}





model Cliente {
  id            Int       @id @default(autoincrement())

  empresa       Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  empresaId     Int

  nombre        String?
  telefono      String          // ID l贸gico principal
  uuid          String? @unique // UUID oficial del CRM (si aplica)
  crmUsuarioId  Int?            // si tu CRM usa id num茅rico y te sirve

  creadoEn      DateTime  @default(now())
  actualizadoEn DateTime  @updatedAt

  sesiones      ChatSession[]

  // Un tel茅fono no se repite dentro de la misma empresa
  @@unique([empresaId, telefono])
}

/* ---------- CHAT ---------- */

model ChatSession {
  id                   Int               @id @default(autoincrement())

  empresa              Empresa           @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  empresaId            Int

  //  Qu茅 bot atendi贸 esta sesi贸n
  bot                  Bot?              @relation(fields: [botId], references: [id])
  botId                Int?

  cliente              Cliente?          @relation(fields: [clienteId], references: [id])
  clienteId            Int?

  telefono             String
  canal                ChatChannel
  estado               ChatSessionStatus @default(OPEN)

  // Integraci贸n con CRM: 煤ltimo ticket creado en esta sesi贸n
  ultimoTicketCrmId    String?
  ultimoTicketCreadoEn DateTime?

  iniciadoEn           DateTime          @default(now())
  cerradoEn            DateTime?
  creadoEn             DateTime          @default(now())
  actualizadoEn        DateTime          @updatedAt

  mensajes             ChatMessage[]

  @@index([empresaId, telefono, canal, estado])
}

model ChatMessage {
  id         Int        @id @default(autoincrement())

  session    ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId  Int

  rol        ChatRole
  contenido  String
  tokens     Int?

  creadoEn   DateTime    @default(now())
  actualizadoEn DateTime         @updatedAt

  @@index([sessionId, creadoEn])
}

/* ---------- RAG: DOCUMENTOS / CHUNKS ---------- */

model KnowledgeDocument {
  id          Int                   @id @default(autoincrement())

  empresa     Empresa               @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  empresaId   Int

  tipo        KnowledgeDocumentType
  externoId   Int?
  origen      String?

  titulo      String
  descripcion String?
  textoLargo String? @db.Text

  // textoLargo   String
  creadoEn      DateTime            @default(now())
  actualizadoEn DateTime            @updatedAt

  chunks      KnowledgeChunk[]

  @@index([empresaId, tipo])
}

model KnowledgeChunk {
  id         Int               @id @default(autoincrement())

  document   KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId Int

  indice     Int
  texto      String

  embedding  Unsupported("vector(4096)")
  tokens     Int?

  creadoEn       DateTime @default(now())
  actualizadoEn  DateTime @updatedAt

  @@index([documentId, indice])
}

/* ---------- RAG: DOCUMENTOS / CHUNKS ---------- */


/* ---------- WHATSAPPP: PERSISTENCIA DE CHATS ---------- */
// model WhatsAppChat {

// }

/* ---------- WHATSAPPP: PERSISTENCIA DE CHATS ---------- */









